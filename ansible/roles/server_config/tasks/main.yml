---
# tasks file for roles/server_config
- name: Get system upgrades
  apt:
    upgrade: dist
    update_cache: yes
    cache_valid_time: 3600
  register: server_system_upgrades
  tags:
    - update_server
    - reboot_machine

- name: Allow incoming SSH conection
  ufw:
    rule: allow
    name: OpenSSH
#  when: personal_pc false
  tags:
    - firewall

- name: Enable firewall on system startup
  ufw:
    state: enabled
    logging: on
  tags:
    - firewall

#- name: UFW set incoming default policy
#  ufw:
#    rule: reject
#    direction: incoming
#  tags:
#    - firewall
#
#- name: UFW set incoming default policy
#  ufw:
#    rule: reject
#    direction: routed
#  tags:
#    - firewall

- name: Install user defined packages
  apt:
    pkg: '{{ item.name }}'
    update_cache: yes
    cache_valid_time: 3600
    state: '{{ item.state }}'
  with_items:
    - "{{ server_apps }}"
  tags:
    - manage_packages

- name: Install apparmor profiles and system utils
  apt:
    pkg: "{{ item }}"
    update_cache: yes
    cache_valid_time: 3600
  with_items:
    - apparmor-profiles
    - apparmor-profiles-extra
    - apparmor-utils

#- name: Allow and manage access on server
#  ufw:
#    rule: '{{ item.value.action }}'
#    interface: '{{ item.value.interface }}'
#    direction: '{{ item.value.direction }}'
#    proto: '{{ item.value.proto }}'
#    src: '{{ item.value.src }}'
#    from_port: '{{ item.value.from_port }}'
#    dest: '{{ item.value.dest }}'
#    to_port: '{{ item.value.to_port }}'
#  with_dict:
#    - "{{ server_allowed_access }}"
#  tags:
#    - manage_fiirewall

- name: Allow and manage access on server
  ufw:
    rule: '{{ item.action }}'
    interface: '{{ item.interface }}'
    direction: '{{ item.direction }}'
    proto: '{{ item.proto }}'
    src: '{{ item.src }}'
    from_port: '{{ item.from_port }}'
    dest: '{{ item.dest }}'
    to_port: '{{ item.to_port }}'
  with_items:
    - "{{ server_allowed_access }}"
  tags:
    - manage_fiirewall

- name: Set server hostname
  hostname:
    name: "{{ server_name }}"
  register: server_system_hostname

- name: Define hostname in hosts file
  lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1'
    line: '127.0.0.1 localhost {{ server_name }}'
    owner: root
    group: root
    mode: 0644

- name: Set server time zone
  timezone:
    name: "{{ server_timezone }}"
  tags:
    - set_timezone

- name: Enable time sync with NTP servers
  shell: timedatectl set-ntp yes
  register: timedateoutput

- name: Display timedatectl output
  debug:
    var: timedateoutput

- name: Configure systemd journal log size and rotate time
  shell: |
    journalctl --vacuum-size="{{ journal_vacuum_size }}"
    journalctl --vacuum-time="{{ journal_vacuum_time }}"
  register: journactloutput

- name: Display journactl output
  debug:
    var: journactloutput

- name: Apply enforce policy to all profiles
  shell: aa-enforce /etc/apparmor.d/*
  register: apparmor_enforce_output
  tags:
    - enforce_apparmor_profiles

- name: Display aa-enforce output
  debug:
    var: apparmor_enforce_output

- name: Create securetty file
  file:
    path: /etc/securetty
    state: touch
    mode: 0644

- name: Insert/Update content in securetty file
  blockinfile:
    path: /etc/securetty
    block: "{{ server_securetty_content }}"

- name: Create logrotate configs from template
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/{{ item.name }}
    owner: root
    group: root
    mode: 0644
  with_items:
    - "{{ server_logrotate_conf }}"
  tags:
    - setup_logrotate

- name: Check if machine required reboot
  stat:
    dest: /var/run/reboot-required
  register: machine_reboot_required
  tags:
    - reboot_machine

- name: Reboot a machine that might have lots of updates to apply
  reboot:
    reboot_timeout: 3600
  when: server_system_upgrades is changed and server_system_hostname is changed or machine_reboot_required.stat.exists
  tags:
    - reboot_machine
